---
title: "Predicting the casualties during prolific days using SPC Outlooks and environmental factors"
author: "Zoe Schroder/James Elsner"
date: "11/18/2018"
output: github_notebook
editor_options: 
chunk_output_type: console
---

Set working directory and load packages.
```{r}
library(lubridate)
library(sf)
library(tmap)
library(USAboundaries)
library(rgeos)
library(dplyr)
library(ggplot2)
library(raster)
library(lubridate)
```

## Part 1: Tornado Data

The newest GIS shapefile contains missing geometries for more than 30% of the tornadoes. The number of missing geometries is highest after 1995. Instead here we use the csv file from https://www.spc.noaa.gov/wcm/#data  Use the start lon/lat and create a `sp` object then convert to `sf`. Set the coordinate reference system (crs) to ESPG 4326.
```{r, eval = FALSE}
Tor.df <- read.csv(file = "1950-2017_actual_tornadoes.csv")
Tor.spdf <- Tor.df
rm(Tor.df)
sp::coordinates(Tor.spdf) <- ~ slon + slat
Tor.sfdf <- st_as_sf(Tor.spdf)
st_crs(Tor.sfdf) <- 4326
```

Remove tornadoes in Hawaii, Alaska, and Puerto Rico and those occurring before 1994. That year marks the beginning of comprehensive WSR-88D radar. For missing EF ratings use the modification rules (if/else) defined here: https://www.spc.noaa.gov/wcm/OneTor_F-scale-modifications.pdf
```{r, eval = FALSE}
Tor.sfdf <- Tor.sfdf %>%
  filter(yr >= 1994,
         !st %in% c("AK", "PR", "HI")) %>%
  mutate(mag = ifelse(mag == -9 & len <= 5, 0, mag),
         mag = ifelse(mag == -9 & len > 5, 1, mag))
```

Add a data/time column also add columns for path length, width, and area in metric units. Leave the time zone as native CDT. Create a convective day (6AM to 6AM) column taking hours 00:00:00 -> 05:59:59 and assigning it to the previous date (this associates the previous day's date to tornadoes occurring up to 6 hours after local midnight).
```{r, eval = FALSE}
Tor.sfdf <- Tor.sfdf %>%
  mutate(dy = format(as.Date(date,format="%m/%d/%y"), "%d"),
         DateTime = as.POSIXct(paste(yr, mo, dy, time), format = "%Y%m%d%H:%M:%S"),
         Hour = hour(DateTime),
         Year = year(DateTime),
         cDateTime = DateTime - as.difftime(6, unit = "hours"),
         cDate = as.Date(as_datetime(ifelse(Hour < 6, (DateTime - 86400), cDateTime), tz = Sys.timezone())),
         Length = len * 1609.34,
         Length = ifelse(Length == 0, min(Length[Length > 0]), Length), #takes care of zero length
         Width = wid * .9144,
         Width = ifelse(Width == 0, min(Width[Width > 0]), Width), #takes care of zero width
         Width = ifelse(Year >= 1995, Width * pi/4, Width), #takes care of change: avg to max
         cas = inj + fat,
         AreaPath = Length * Width,
         Ma = factor(month.abb[mo], levels = month.abb[1:12])) %>%
  sf::st_sf()
max(Tor.sfdf$yr)
```

The geometry type is `POINT`. Each tornado is represented as a single point location geometry (start location). 

Add energy dissipation per tornado. Use the empirical model for tornado winds by EF rating taken from Table 3-1 of NRC 2007. Percent area by EF rating for each EF category. Threshold wind speeds (m/s) are a lower bound 3-sec gusts on the operational EF Scale (Table 2-1 of NRC2007). This is based on work by Fricker et al. (2017). The model is
$$
E = A_p \rho \sum_{j=0}^{J} w_j v_j^{3},
$$
where $A_p$ is the area of the path, $\rho$ is area density [1 kg/m^3]  $v_j$ is the midpoint wind speed for each rating, and $w_j$ is the corresponding fraction of path area by EF rating. With no upper bound on the EF5 wind speeds, the midpoint wind speed is set at 97 m~s$^{-1}$ (7.5 m~s$^{-1}$ above the threshold wind speed consistent with the EF4 midpoint speed relative to its threshold)
```{r, eval = FALSE}
perc <- c(1, 0, 0, 0, 0, 0, 
          .772, .228, 0, 0, 0, 0,
          .616, .268, .115, 0, 0, 0,
          .529, .271, .133, .067, 0, 0,
          .543, .238, .131, .056, .032, 0,
          .538, .223, .119, .07, .033, .017)
percM <- matrix(perc, ncol = 6, byrow = TRUE)
threshW <- c(29.06, 38.45, 49.62, 60.8, 74.21, 89.41)
midptW <- c(diff(threshW)/2 + threshW[-length(threshW)], threshW[length(threshW)] + 7.5)
ef <- Tor.sfdf$mag + 1
EW3 <- numeric()
for(i in 1:length(ef)) EW3[i] = midptW^3 %*% percM[ef[i], ]
Tor.sfdf <- Tor.sfdf %>%
  mutate(ED = EW3 * AreaPath)
```

Determine the distance between tornadoes in space and time. Use a projection, not lat/lon. See https://epsg.io/102004. Extract the coordinates of the start locations as a N by 2 matrix, where N is the number of tornadoes. Also extract the date-time as a vector of class `POSIXct`.
```{r, eval = FALSE}
Tor.sfdfT <- st_transform(Tor.sfdf, crs = 102004)
space <- st_coordinates(Tor.sfdfT)
time <- Tor.sfdf$DateTime
```

Next compute pairwise Euclidean distances in space and, separately, in time using the `dist()` function. Divide the spatial distance by 10 so that the values are commensurate with the time 'distance' based on the assumption of 10 meters every second for an average speed of tornado-generating storms. 

Compare: Distance from New York to Denver is 2.622 x 10^6 meters. There are 3.154 x 10^7 seconds in a year. This will capture the historic multiday tornado outbreaks. For analysis we want to consider each day in the multiday group separately. As the value of the divisor increases cluster areas get larger. Remove `ds` and `dt` to free memory.
```{r, eval = FALSE}
ds <- dist(space) / 10
dt <- dist(time)
dst <- ds + dt
rm(ds, dt)
```

Distances are saved as an object of class `dist` containing a vector of length N * (N-1)/2, which is the number of unique point pairs.

Next group the tornadoes based on the space-time distances. This is done with the `hclust()` (hierarchical cluster) function. Initially, each tornado is assigned to its own group and then the algorithm joins the two closest tornadoes determined by values in `dst`. The algorithm continues by joining tornadoes (and tornado groups) until there is a single large group.

The single linkage method (`method = "single"`) is related to the minimal spanning tree (MST) and adopts a 'friends of friends' grouping strategy. An edge-weighted graph is a graph where each edge has a weight (or cost). Here weights are space-time distances between tornadoes. A MST of an edge-weighted graph is a spanning tree whose weight (the sum of the weights of its edges) is no larger than the weight of any other spanning tree. A spanning tree of a graph on N vertices (tornado centroids) is a subset of N-1 edges that form a tree (Skiena 1990, p. 227).
 
The `cutree()` function is used to extract a group number for each tornado. Tornadoes in each group are close in space & time. Here the tree is cut at a height of 50000 space-time units. Making `h` smaller results in smaller groups (fewer tornadoes per group).
```{r, eval = FALSE}
stime <- proc.time()
tree <- hclust(dst, method = "single")
groupNumber <- as.integer(cutree(tree, h = 50000))
proc.time() - stime
```

Add the group number to each tornado. 
```{r, eval = FALSE}
Tor.sfdfT$groupNumber <- groupNumber
```

Create an ID for unique big days. It needs to have the group number and the cDate because there are multiple group numbers in each cDate. Similarly, there are multiple cDates in each groupnumber. An ID helps retrieve appropriate/unique big days. 
```{r}
Tor.sfdfT <- Tor.sfdfT %>%
   mutate(ID = paste0(gsub("-", "", cDate), groupNumber))
```

Compute big day-level statistics. Keep only days with at least 10 tornadoes. 
```{r, eval = FALSE}
BigDays.sfdfT <- Tor.sfdfT %>%
  group_by(ID, groupNumber, cDate) %>%
  summarize(Year = first(Year),
            Month = first(mo),
            FirstDate = first(date),
            LastDate = last(date),
            DateRange = paste(FirstDate, "to", LastDate),
            FirstcDate = first(cDate),
            LastcDate = last(cDate),
            ncD = n_distinct(cDate),
            casualties = sum(cas),
            nT = n(),
            n0 = sum(mag == 0),
            n1 = sum(mag == 1),
            n2 = sum(mag == 2),
            n3 = sum(mag == 3),
            n4 = sum(mag == 4),
            n5 = sum(mag == 5),
            GroupTotalED = sum(ED),
            GroupTotalEDinTW = paste(round(GroupTotalED/10^12), "TW"),
            maxEF = max(mag),
            nD = n_distinct(date),
            StartTime = first(DateTime),
            EndTime = last(DateTime),
            Duration = difftime(EndTime, StartTime, units = "secs")) %>%
  filter(nT >= 10)
dim(BigDays.sfdfT)
```

Extract a vector of the big days. Save as a .csv for NARR download. 
```{r, eval = FALSE}
bigdays <- BigDays.sfdfT$cDate
write.csv(bigdays, "BigDays.csv")
```

Save the Big Days to a file `BigDays.RData`.
```{r}
#save(BigDays.sfdfT, file = "BigDays.RData")
load("BigDays.RData")
dim(BigDays.sfdfT)
```

Pull out the individual tornadoes associated with each Big Day. 
```{r, eval = FALSE}
groups <- BigDays.sfdfT$ID
Tor.sfdfT <- Tor.sfdfT %>%
  filter(ID %in% groups) 
```

Save the Tornadoes to a file `BigDayTornadoes.RData`.
```{r}
#save(Tor.sfdfT, file = "BigDayTornadoes.RData")
load("BigDayTornadoes.RData")
dim(Tor.sfdfT)
```

## Make some images: 

Get the centroid (central point of the tornado activity) for each big day. 
```{r}
BigDayCentroids.sfdfT <- st_centroid(BigDays.sfdfT)
BigDayCentroids.sfdfT$groupArea <- st_area(st_convex_hull(BigDays.sfdfT))
BigDayCentroids.sfdfT$groupDensity <- BigDayCentroids.sfdfT$nT/BigDayCentroids.sfdfT$groupArea
```

Set the state and county borders. 
```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
counties.sf <- us_counties()
```

Plot the centroids of all big days. Size by the number of casualties. ** The legend is wrong, but the sizes appear correct **
```{r}
tm_shape(stateBorders) + 
  tm_borders(col = "darkgray", alpha = 1) +
  tm_compass() + tm_scale_bar() +
  tm_layout(legend.bg.color = "white", legend.text.size = .75) +
tm_shape(counties.sf) +
  tm_borders(col = "gray", alpha = .3) +
  tm_compass() + 
  tm_scale_bar() +
  tm_format_World(legend.position = c("right", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE,
                   #title = "Big Day centroids",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
                   inner.margins = c(.05, .05, .1, .05)) +
tm_shape(BigDayCentroids.sfdfT) +
  tm_symbols(size = "casualties", title.size = "Count", legend.size.is.portrait = FALSE, shape =24) + 
  tm_layout(
  legend.title.size=1,
  legend.text.size = 0.6,
  legend.position = c("right","bottom"),
  legend.bg.color = "white",
  legend.bg.alpha = 1)
```

Get the casualty count by state:
```{r}
casualty <- Tor.sfdfT %>%
  group_by(st) %>%
  summarize(cas = n())


states.sf <- us_states()

states.sf <- states.sf %>%
  filter(!stusps %in% c("AK", "PR", "HI")) %>%
  arrange(-desc(state_name))

#states.sf$totalcasualties <- colSums(Tor.sfdfT)



tm_shape(states.sf) + 
  tm_borders(col = "darkgray", alpha = 1) +
  tm_compass() + tm_scale_bar() +
  tm_layout(legend.bg.color = "white", legend.text.size = .75)
tm_shape(counties.sf) +
   tm_fill("GroupDayCount",
            title = "Count",
            palette = "Reds", n = 5) +
  tm_borders(col = "gray", alpha = .3) +
  tm_compass() + 
  tm_scale_bar() +
  tm_layout(legend.position = c("right", "bottom"),
                   attr.position = c("left", "bottom"),
                   legend.frame = FALSE,
                   #title = "Tornado Group Days by County [1994-2017]",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
                   inner.margins = c(.05, .05, .1, .05))

```

Plot the number of casualties by state. 
```{r}
%>%
  arrange(asc(nT))
```

Time Series of casualty counts over time. 
```{r}
casualty <- Tor.sfdfT %>%
  group_by(st) %>%
  summarize(cas = n())
```

Plot the relationship between GroupDayTotalED (ATE) and casualties. 
```{r}

```




## NARR data: 
Data is downloaded from NCAR's North American Regional Reanalysis (https://rda.ucar.edu/datasets/ds608.0/#!access). It extends from 1-1-1979 to 11-1-2018. Use the NCAR NARR 3-hourly files.  

Spatial Extent: 
Longitude Range: Westernmost = 148.64E Easternmost = 2.568W
Latitude Range: Southernmost = 0.897N Northernmost = 85.333N 

The list of all variables can be found here: http://www.emc.ncep.noaa.gov/mmb/rreanl/merged_land_AWIP32.pdf 

```{r}
df <- BigDays.sfdfT %>%
  mutate(YrMoDa = gsub("-", "", BigDays.sfdfT$cDate),
         ztime = 18,
         slug = paste0("merged_AWIP32.",YrMoDa, ztime)) 
slug <- df$slug
```

```{r}
aCAPE <- numeric()
aHLCY <- numeric()
aCIN <- numeric()
aUSTM <- numeric()
aVSTM <- numeric()
aBS <- numeric()
aRATIO <- numeric()
mCAPE <- numeric()
mHLCY <- numeric()
mCIN <- numeric()
mUSTM <- numeric()
mVSTM <- numeric()
mBS <- numeric()
 
#i = 652 for example!
for(i in 1:length(slug)){
  print(i)
  rb <- brick(paste0("NCARNARR/merged_AWIP32.", df$YrMoDa[i], df$ztime[i]))
  CAPE.rl <- raster(rb, layer = 375)
  HLCY.rl <- raster(rb, layer = 323)
  CIN.rl <- raster(rb, layer = 376)
  USTM.rl <- raster(rb, layer = 324)
  VSTM.rl <- raster(rb, layer = 325)
  BS.rl <- sqrt(USTM.rl^2 + VSTM.rl^2)
  RATIO.rl <- CAPE.rl/abs(CIN.rl)
  aCAPE <- c(aCAPE, as.numeric(raster::extract(CAPE.rl, df[i, ], fun = mean)))
  aHLCY <- c(aHLCY, as.numeric(raster::extract(HLCY.rl, df[i, ], fun = mean)))
  aCIN <- c(aCIN, as.numeric(raster::extract(CIN.rl, df[i, ], fun = mean)))
  aUSTM <- c(aUSTM, as.numeric(raster::extract(USTM.rl, df[i, ], fun = mean)))
  aVSTM <- c(aVSTM, as.numeric(raster::extract(VSTM.rl, df[i, ], fun = mean)))
  aBS <- c(aBS, as.numeric(raster::extract(BS.rl, df[i, ], fun = mean)))
  aRATIO <- c(aRATIO, as.numeric(raster::extract(RATIO.rl, df[i, ], fun = mean)))
  mCAPE <- c(mCAPE, as.numeric(raster::extract(CAPE.rl, df[i, ], fun = max)))
  mHLCY <- c(mHLCY, as.numeric(raster::extract(HLCY.rl, df[i, ], fun = max)))
  mCIN <- c(mCIN, as.numeric(raster::extract(CIN.rl, df[i, ], fun = min)))
  mUSTM <- c(mUSTM, as.numeric(raster::extract(USTM.rl, df[i, ], fun = max)))
  mVSTM <- c(mVSTM, as.numeric(raster::extract(VSTM.rl, df[i, ], fun = max)))
  mBS <- c(mBS, as.numeric(raster::extract(BS.rl, df[i, ], fun = max)))
}
```


## SPC Outlooks

The SPC archive data extends from January 23, 2003 to present. (https://www.spc.noaa.gov/archive/)

Data File Example: 
https://www.spc.noaa.gov/cgi-bin-spc/getacrange.pl?date0=20110426&date1=20110426&csrf=0e9284c1e6fff8bc469a08cd5379c18197cc4fec/day1otlk_20110426_1630-shp.zip 